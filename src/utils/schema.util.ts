import {OPENTEST_TEST_SCHEMA_PATH} from "../constants";
import Ajv from "ajv";
import addFormats from 'ajv-formats';
import addMetaSchema2020 from 'ajv/dist/refs/json-schema-2020-12';
import {TestFileType} from "../types/testFile.type";
import fs from 'fs';
import {ErrorObject} from "ajv/lib/types";

const ajv = new Ajv({allErrors: true, strict: false});
const schemaFile = fs.readFileSync(OPENTEST_TEST_SCHEMA_PATH, "utf8");

addFormats(ajv);
addMetaSchema2020.call(ajv);

/**
 * Validate a TestFileType against opentest schema
 * @param file
 */
export function validateSchema(file: TestFileType): { success: boolean, errors?: null | ErrorObject[] } {
    const schema = JSON.parse(schemaFile);
    const validate = ajv.compile(schema);
    const valid: boolean = validate(file)
    return {
        success: valid,
        errors: validate.errors
    };
}