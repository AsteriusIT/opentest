import fs from "fs";
import {parse} from "yaml";
import {OpenapiType} from "../types/openapi.type";
import {TestFileType} from "../types/testFile.type";

/**
 * Open and parse a OpenAPI test file.
 *
 * @param openApiTestFilePath
 */
export function getOpenApiTestFile(openApiTestFilePath: string): TestFileType {
    // Check if the file exists
    if (!fs.existsSync(openApiTestFilePath)) {
        throw new Error(`File not found: ${openApiTestFilePath}`);
    }

    // Read the file content
    const testsFile = fs.readFileSync(openApiTestFilePath, "utf8");

    // Parse the file content to JSON
    const parsedFile = JSON.parse(testsFile);

    // Ensure the parsed file has the expected structure
    if (!parsedFile || !Array.isArray(parsedFile.tests)) {
        throw new Error('Invalid test file structure. Expected a "tests" array.');
    }

    return parsedFile as TestFileType;
}

/**
 * Open and parse a OpenAPI specification file.
 *
 * @param openApiFilePath
 */
export function getOpenApiFile(openApiFilePath: string): OpenapiType {

    // Check if the file exists
    if (!fs.existsSync(openApiFilePath)) {
        throw new Error(`File not found: ${openApiFilePath}`);
    }

    // Read the file content
    const openApiFile = fs.readFileSync(openApiFilePath, "utf8");

    // Parse the file content
    const spec = parse(openApiFile);

    // Ensure the parsed file has the expected structure
    if (!spec) {
        throw new Error('Invalid test file structure. Expected a "tests" array.');
    }

    return spec as OpenapiType;
}