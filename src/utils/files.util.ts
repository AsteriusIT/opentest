import fs from "fs";
import {parse} from "yaml";
import {TestFileType} from "../types/testFile.type";
import {OpenAPIV3} from "openapi-types";

/**
 * Open and parse a OpenAPI test file.
 *
 * @param openApiTestFilePath
 */
export function getOpenApiTestFile(openApiTestFilePath: string): TestFileType {
    // Check if the file exists
    if (!fs.existsSync(openApiTestFilePath)) {
        throw new Error(`File not found: ${openApiTestFilePath}`);
    }

    // Read the file content
    const testsFile = fs.readFileSync(openApiTestFilePath, "utf8");

    // Parse the file content to JSON
    const parsedFile: TestFileType = JSON.parse(testsFile);

    // Ensure the parsed file has the expected structure
    if (!parsedFile || !Array.isArray(parsedFile.tests)) {
        throw new Error('Invalid test file structure. Expected a "tests" array.');
    }

    return parsedFile;
}

/**
 * Open and parse a OpenAPI specification file.
 *
 * @param openApiFilePath
 */
export function getOpenApiFile(openApiFilePath: string): OpenAPIV3.Document {

    // Check if the file exists
    if (!fs.existsSync(openApiFilePath)) {
        throw new Error(`File not found: ${openApiFilePath}`);
    }

    // Read the file content
    const openApiFile = fs.readFileSync(openApiFilePath, "utf8");

    return parse(openApiFile) as OpenAPIV3.Document;
}