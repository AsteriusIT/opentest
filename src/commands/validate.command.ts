import fs from 'fs';
import Ajv from "ajv"
import addFormats from 'ajv-formats';
import addMetaSchema2020 from 'ajv/dist/refs/json-schema-2020-12';
import {TestCaseType} from '../types/testCase.type';
import {getOpenApiTestFile} from '../utils/files.util';

const OPENTEST_TEST_SCHEMA_PATH = "schemas/test.opentest-schema.json";

export const validateCommandHandler = (options: { input: string }) => {
    const testsFilePath: string = options.input;

    // Parse test cases (json)
    const tests: { tests: TestCaseType[] } = getOpenApiTestFile(testsFilePath)

    // Validate test cases against schema
    const ajv = new Ajv({allErrors: true, strict: false});

    const schemaFile = fs.readFileSync(OPENTEST_TEST_SCHEMA_PATH, "utf8");
    const schema = JSON.parse(schemaFile);
    addFormats(ajv);
    addMetaSchema2020.call(ajv);

    const validate = ajv.compile(schema);
    const valid = validate(tests);

    if (!valid) {
        console.error("Validation failed: ", validate.errors);
        process.exit(1);
    }

    console.log("OpenAPI test file is valid")
};
